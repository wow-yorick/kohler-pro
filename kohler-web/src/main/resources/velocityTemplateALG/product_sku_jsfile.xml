<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<page xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="productSKUjsFileData" param="@product_id,@template_type,@lang">

	<!-- sku 图片切换列表 --> 	
	<multidata name="sku" sqlResource="SELECT SA.SKU_METADATA_ID,
   CONCAT('[',GROUP_CONCAT(CONCAT('{&amp;sku_attr_id&amp;:',CSA.CATEGORY_SKU_ATTR_METADATA_ID,',&amp;sku_attr_name&amp;:&amp;',CSA.CATEGORY_SKU_ATTR_NAME,'&amp;,&amp;sku_attr_value_id&amp;:&amp;',CSAV.CATEGORY_SKU_ATTR_VALUES_METADATA_ID,'&amp;,&amp;sku_attr_value_name&amp;:&amp;',CSAV.ATTR_VALUE,'&amp;}') separator ','),']') AS REAL_ATTR, 
S.SKU_CODE,S.SKU_PRICE,S.IS_DEFAULT,S.IMAGE_SOURCE,S.DETAIL_IMAGE1_URL,S.DETAIL_IMAGE1_ID,
S.DETAIL_IMAGE2_URL,S.DETAIL_IMAGE2_ID,
S.DETAIL_IMAGE3_URL,S.DETAIL_IMAGE3_ID,
S.DETAIL_IMAGE4_URL,S.DETAIL_IMAGE4_ID,
S.DETAIL_IMAGE5_URL,S.DETAIL_IMAGE5_ID
	FROM SKU_ATTR AS SA 
	LEFT JOIN VW_SKU AS S ON SA.SKU_METADATA_ID = S.SKU_METADATA_ID 
	LEFT JOIN VW_CATEGORY_SKU_ATTR AS CSA ON CSA.CATEGORY_SKU_ATTR_METADATA_ID = SA.CATEGORY_SKU_ATTR_METADATA_ID AND CSA.LANG = S.LANG 
	LEFT JOIN VW_CATEGORY_SKU_ATTR_VALUES AS CSAV ON SA.CATEGORY_SKU_ATTR_VALUES_METADATA_ID = CSAV.CATEGORY_SKU_ATTR_VALUES_METADATA_ID AND CSAV.LANG = S.LANG 
	WHERE S.LANG = @lang AND S.PRODUCT_METADATA_ID=@product_id
GROUP BY SA.SKU_METADATA_ID" keyName="SKU_METADATA_ID" >
		<field name="SKU_METADATA_ID" fieldType="physicalValue" fieldName="SKU_METADATA_ID"/>
		<field name="sku_metadata_id" fieldType="physicalValue" fieldName="SKU_METADATA_ID"/>
		<field name="sku_code" fieldType="physicalValue" fieldName="SKU_CODE"/>
		<field name="sku_price" fieldType="physicalValue" fieldName="SKU_PRICE" />
		<field name="is_default" fieldType="physicalValue" fieldName="IS_DEFAULT" />
		<field name="detail_image1_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE1_URL" fileAssetInternal="DETAIL_IMAGE1_ID"/>
		<field name="detail_image1_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image2_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE2_URL" fileAssetInternal="DETAIL_IMAGE2_ID"/>
		<field name="detail_image2_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image3_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE3_URL" fileAssetInternal="DETAIL_IMAGE3_ID"/>
		<field name="detail_image3_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image4_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE4_URL" fileAssetInternal="DETAIL_IMAGE4_ID"/>
		<field name="detail_image4_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image5_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE5_URL" fileAssetInternal="DETAIL_IMAGE5_ID"/>
		<field name="detail_image5_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="real_attr" fieldType="physicalValue" fieldName="REAL_ATTR" />

		
		<!-- 产品配件  SKU_ACCESSORY -->
		<multidata name="include_accessorys" sqlResource="SELECT sku.SKU_METADATA_ID,sku.PRODUCT_METADATA_ID,sku.SKU_CODE,vp.PRODUCT_NAME, cam.CATEGORY_ACCESSORY_TYPE,sa.ACCESSORY_DESCRIPTION
			 FROM SKU_ACCESSORY sa 
			 LEFT JOIN SKU_METADATA sku ON sa.SKU_PICK_ID = sku.SKU_METADATA_ID  
             LEFT JOIN CATEGORY_ACCESSORY AS cam ON cam.CATEGORY_ACCESSORY_METADATA_ID = sa.CATEGORY_ACCESSORY_METADATA_ID AND cam.LANG = sa.LANG
			 LEFT JOIN VW_PRODUCT vp ON sku.PRODUCT_METADATA_ID = vp.PRODUCT_METADATA_ID AND vp.LANG = sa.LANG
			 WHERE sa.LANG = @lang AND sa.SKU_METADATA_ID = @@SKU_METADATA_ID " >
			<field name="PRODUCT_METADATA_ID" fieldType="physicalValue" fieldName="PRODUCT_METADATA_ID"/>
			<field name="name" fieldType="physicalValue" fieldName="PRODUCT_NAME"/>
			<field name="sku_code" fieldType="physicalValue" fieldName="SKU_CODE"/>
			<field name="category_accessory_type" fieldType="physicalValue" fieldName="CATEGORY_ACCESSORY_TYPE"/>
			<field name="accessory_decription" fieldType="physicalValue" fieldName="ACCESSORY_DESCRIPTION"/>
			<field name="product_url" fieldType="urlValue" dependOn="PRODUCT_METADATA_ID"  service="productUrlAnalysis" />
		</multidata>
		
	</multidata>
	
	
	<!--category sku 属性分类 -->
	<multidata name="sku_attributes" keyName="CATEGORY_SKU_ATTR_METADATA_ID" tableName="VW_CATEGORY_SKU_ATTR"  filter="CATEGORY_METADATA_ID=(SELECT CATEGORY_METADATA_ID FROM VW_PRODUCT WHERE PRODUCT_METADATA_ID=@product_id AND lang=@lang) AND lang=@lang  
 AND CATEGORY_SKU_ATTR_METADATA_ID IN (SELECT CATEGORY_SKU_ATTR_METADATA_ID FROM SKU_ATTR AS SA, SKU_METADATA AS SM WHERE SA.SKU_METADATA_ID = SM.SKU_METADATA_ID AND SM.PRODUCT_METADATA_ID = @product_id)" >
		<field name="attrname" fieldType="physicalValue" fieldName="CATEGORY_SKU_ATTR_NAME"/>
		<field name="sku_id" fieldType="physicalValue" fieldName="CATEGORY_SKU_ATTR_METADATA_ID"/>
		
		<!-- category sku 属性分类值 -->
		<multidata name="sku_attributes_values" sqlResource="SELECT
	d.ATTR_VALUE,
	d.IMAGE_ID,
	d.CATEGORY_SKU_ATTR_VALUES_METADATA_ID
FROM
	VW_CATEGORY_SKU_ATTR_VALUES d
WHERE
	d.CATEGORY_SKU_ATTR_METADATA_ID = @@CATEGORY_SKU_ATTR_METADATA_ID
AND d.LANG = @lang" >
			<field name="attr_value" fieldType="physicalValue" fieldName="ATTR_VALUE"/>
			<field name="category_sku_attr_values_metadata_id" fieldType="physicalValue" fieldName="CATEGORY_SKU_ATTR_VALUES_METADATA_ID"/>
			<field name="attr_image_url" fieldType="internalFileAsset" fieldName="IMAGE_ID"/>
		</multidata>
		
	</multidata>
</page>