<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<page xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="productData" param="@product_id,@template_type,@lang">

	<!-- seo 信息 -->
	<data name="seo" tableName="VW_PRODUCT" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
		<field name="seo_title" fieldType="physicalValue" fieldName="IF(@template_type = 'pc', SEO_TITLE_PC, SEO_TITLE_MOBILE)"/>
		<field name="seo_keywords" fieldType="physicalValue" fieldName="IF(@pc_or_mobile = 'pc', SEO_KEYWORDS_PC, SEO_KEYWORDS_MOBILE)"/>
		<field name="seo_description" fieldType="physicalValue" fieldName="IF(@pc_or_mobile = 'pc', SEO_DESCRIPTION_PC, SEO_DESCRIPTION_MOBILE)"/>
	</data>
	
	<!-- 面包屑 -->
	<funcdata name="breadcrumb_name" from="getBreadcrumb" />
	
	<!-- 产品信息 -->
	<data name="product" tableName="VW_PRODUCT" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
		<field name="product_id"  fieldType="physicalValue" fieldName="PRODUCT_ID" />
		<field name="product_name" fieldType="physicalValue" fieldName="PRODUCT_NAME"/>
	</data>
	
	<!-- sku 图片切换列表 --> 	
	<multidata name="sku" sqlResource="SELECT SA.SKU_METADATA_ID,
 GROUP_CONCAT(CONCAT(CSA.CATEGORY_SKU_ATTR_METADATA_ID,':',CSAV.ATTR_VALUE) separator ';') AS REAL_ATTR, 
S.SKU_CODE,S.SKU_PRICE,S.IS_DEFAULT,S.IMAGE_SOURCE,S.DETAIL_IMAGE1_URL,S.DETAIL_IMAGE1_ID,
S.DETAIL_IMAGE2_URL,S.DETAIL_IMAGE2_ID,
S.DETAIL_IMAGE3_URL,S.DETAIL_IMAGE3_ID,
S.DETAIL_IMAGE4_URL,S.DETAIL_IMAGE4_ID,
S.DETAIL_IMAGE5_URL,S.DETAIL_IMAGE5_ID
	FROM SKU_ATTR AS SA 
	LEFT JOIN VW_SKU AS S ON SA.SKU_METADATA_ID = S.SKU_METADATA_ID 
	LEFT JOIN VW_CATEGORY_SKU_ATTR AS CSA ON CSA.CATEGORY_SKU_ATTR_METADATA_ID = SA.CATEGORY_SKU_ATTR_METADATA_ID AND CSA.LANG = S.LANG 
	LEFT JOIN VW_CATEGORY_SKU_ATTR_VALUES AS CSAV ON SA.CATEGORY_SKU_ATTR_VALUES_METADATA_ID = CSAV.CATEGORY_SKU_ATTR_VALUES_METADATA_ID AND CSAV.LANG = S.LANG 
	WHERE S.LANG = @lang AND S.PRODUCT_METADATA_ID=@product_id
GROUP BY SA.SKU_METADATA_ID" keyName="SKU_METADATA_ID" >
		<field name="SKU_METADATA_ID" fieldType="physicalValue" fieldName="SKU_METADATA_ID"/>
		<field name="sku_metadata_id" fieldType="physicalValue" fieldName="SKU_METADATA_ID"/>
		<field name="sku_code" fieldType="physicalValue" fieldName="SKU_CODE"/>
		<field name="sku_price" fieldType="physicalValue" fieldName="SKU_PRICE" />
		<field name="is_default" fieldType="physicalValue" fieldName="IS_DEFAULT" />
		<field name="detail_image1_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE1_URL" fileAssetInternal="DETAIL_IMAGE1_ID"/>
		<field name="detail_image1_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image2_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE2_URL" fileAssetInternal="DETAIL_IMAGE2_ID"/>
		<field name="detail_image2_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image3_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE3_URL" fileAssetInternal="DETAIL_IMAGE3_ID"/>
		<field name="detail_image3_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image4_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE4_URL" fileAssetInternal="DETAIL_IMAGE4_ID"/>
		<field name="detail_image4_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="detail_image5_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="DETAIL_IMAGE5_URL" fileAssetInternal="DETAIL_IMAGE5_ID"/>
		<field name="detail_image5_alt" fieldType="physicalValue" fieldName="DETAIL_IMAGE1_ALT" />
		<field name="real_attr" fieldType="physicalValue" fieldName="REAL_ATTR" />

		
		<!-- 产品配件  SKU_ACCESSORY -->
		<multidata name="include_accessorys" sqlResource="SELECT sku.SKU_METADATA_ID,sku.PRODUCT_METADATA_ID,sku.SKU_CODE,vp.PRODUCT_NAME 
			 FROM SKU_ACCESSORY sa 
			 LEFT JOIN SKU_METADATA sku ON sa.SKU_PICK_ID = sku.SKU_METADATA_ID 
			 LEFT JOIN VW_PRODUCT vp ON sku.PRODUCT_METADATA_ID = vp.PRODUCT_METADATA_ID AND vp.LANG = @lang
			 WHERE sa.LANG = @lang AND sa.SKU_METADATA_ID = @@SKU_METADATA_ID" >
			 <field name="PRODUCT_METADATA_ID" fieldType="physicalValue" fieldName="PRODUCT_METADATA_ID"/>
			<field name="name" fieldType="physicalValue" fieldName="PRODUCT_NAME"/>
			<field name="sku_code" fieldType="physicalValue" fieldName="SKU_CODE"/>
			<field name="product_url" fieldType="urlValue" dependOn="PRODUCT_METADATA_ID"  service="productUrlAnalysis" />
		</multidata>
	</multidata>
	
	<!-- 特征 -->
	<data name="feature" sqlResource="SELECT pa.`VALUE`,ca.CATEGORY_COM_ATTR_NAME,cam.KEY_NAME 
	 FROM PRODUCT_COM_ATTR pa 
	  INNER JOIN  CATEGORY_COM_ATTR ca ON pa.CATEGORY_COM_ATTR_METADATA_ID =ca.CATEGORY_COM_ATTR_METADATA_ID 
	  LEFT JOIN CATEGORY_COM_ATTR_METADATA cam ON  ca.CATEGORY_COM_ATTR_METADATA_ID = cam.CATEGORY_COM_ATTR_METADATA_ID
	   WHERE ca.LANG=@lang AND ca.IS_ENABLE=1 AND pa.IS_ENABLE = 1 AND pa.PRODUCT_METADATA_ID = @product_id AND pa.LANG=@lang AND cam.KEY_NAME = 'feature'" >
	   	<field name="value" fieldType="physicalValue" fieldName="VALUE"/>
		<field name="name" fieldType="physicalValue" fieldName="CATEGORY_COM_ATTR_NAME"/>
	 </data>
	 
	 <!-- 产品故事 -->
	<data name="story" sqlResource="SELECT pa.`VALUE`,ca.CATEGORY_COM_ATTR_NAME,cam.KEY_NAME,cam.SEQ_NO,cam.INPUT_TYPE,cam.IS_FILTER,ca.IMAGE_URL,ca.IMAGE_SOURCE,ca.IMAGE_ID,ca.IMAGE_TOOLTIP
	 FROM PRODUCT_COM_ATTR pa 
	  INNER JOIN  CATEGORY_COM_ATTR ca ON pa.CATEGORY_COM_ATTR_METADATA_ID =ca.CATEGORY_COM_ATTR_METADATA_ID 
	  LEFT JOIN CATEGORY_COM_ATTR_METADATA cam ON  ca.CATEGORY_COM_ATTR_METADATA_ID = cam.CATEGORY_COM_ATTR_METADATA_ID
	   WHERE ca.LANG=@lang AND ca.IS_ENABLE=1 AND pa.IS_ENABLE = 1 AND pa.PRODUCT_METADATA_ID = @product_id AND pa.LANG=@lang AND cam.KEY_NAME = 'story'" >
	   	<field name="value" fieldType="physicalValue" fieldName="VALUE"/>
		<field name="name" fieldType="physicalValue" fieldName="CATEGORY_COM_ATTR_NAME"/>
	 </data>
	 
	 <!-- 细节亮点 -->
	<data name="detail_highlight" sqlResource="SELECT pa.`VALUE`,ca.CATEGORY_COM_ATTR_NAME,cam.KEY_NAME,cam.SEQ_NO,cam.INPUT_TYPE,cam.IS_FILTER,ca.IMAGE_URL,ca.IMAGE_SOURCE,ca.IMAGE_ID,ca.IMAGE_TOOLTIP
	 FROM PRODUCT_COM_ATTR pa 
	  INNER JOIN  CATEGORY_COM_ATTR ca ON pa.CATEGORY_COM_ATTR_METADATA_ID =ca.CATEGORY_COM_ATTR_METADATA_ID 
	  LEFT JOIN CATEGORY_COM_ATTR_METADATA cam ON  ca.CATEGORY_COM_ATTR_METADATA_ID = cam.CATEGORY_COM_ATTR_METADATA_ID
	   WHERE ca.LANG=@lang AND ca.IS_ENABLE=1 AND pa.IS_ENABLE = 1 AND pa.PRODUCT_METADATA_ID = @product_id AND pa.LANG=@lang AND cam.KEY_NAME = 'detail_highlight'" >
	   	<field name="value" fieldType="physicalValue" fieldName="VALUE"/>
		<field name="name" fieldType="physicalValue" fieldName="CATEGORY_COM_ATTR_NAME"/>
	 </data>
	 
	 <!-- 产品所属系列  -->
	 <data name="collection" keyName="COLLECTION_METADATA_ID" sqlResource="SELECT COLLECTION_NAME,c.COLLECTION_METADATA_ID FROM COLLECTION c INNER JOIN PRODUCT_METADATA p ON c.COLLECTION_METADATA_ID = p.COLLECTION_METADATA_ID WHERE PRODUCT_METADATA_ID=@product_id AND c.LANG = @lang" >
	   		<field name="name" fieldType="physicalValue" fieldName="COLLECTION_NAME"/>
	 </data>
	 
	 <!-- 最佳拍档 -->
	<funcdata name="pair_well_with" from="getCommonAttrProduct" parameter="pair_well_with" />
	
	<!-- 同系列产品 -->
	<funcdata name="same_collection" from="getCommonAttrProduct" parameter="pair_well_with" />
	
	<!-- 相似产品  推荐产品-->
	<funcdata name="recommended" from="getCommonAttrProduct" parameter="pair_well_with" />
	
	<!-- 同产品线产品-->
	<funcdata name="same_line" from="getCommonAttrProduct" parameter="pair_well_with" />
	 
	
	<!-- 公共属性 -->
	<multidata name="common_attr" sqlResource="SELECT pa.`VALUE`,ca.CATEGORY_COM_ATTR_NAME,cam.KEY_NAME,cam.SEQ_NO,cam.INPUT_TYPE,cam.IS_FILTER,ca.IMAGE_URL,ca.IMAGE_SOURCE,ca.IMAGE_ID,ca.IMAGE_TOOLTIP
	 FROM PRODUCT_COM_ATTR pa 
	  INNER JOIN  CATEGORY_COM_ATTR ca ON pa.CATEGORY_COM_ATTR_METADATA_ID =ca.CATEGORY_COM_ATTR_METADATA_ID 
	  LEFT JOIN CATEGORY_COM_ATTR_METADATA cam ON  ca.CATEGORY_COM_ATTR_METADATA_ID = cam.CATEGORY_COM_ATTR_METADATA_ID
	   WHERE ca.LANG=@lang AND ca.IS_ENABLE=1 AND pa.IS_ENABLE = 1 AND pa.PRODUCT_METADATA_ID = @product_id AND pa.LANG=@lang AND cam.KEY_NAME != 'feature'  AND cam.KEY_NAME != 'story'" >
			<field name="category_com_attr_name" fieldType="physicalValue" fieldName="CATEGORY_COM_ATTR_NAME" />
			<field name="key_name" fieldType="physicalValue" fieldName="KEY_NAME" />
			<field name="seq_no" fieldType="physicalValue" fieldName="SEQ_NO"/>
			<field name="input_type" fieldType="physicalValue" fieldName="INPUT_TYPE"/>
			<field name="is_filter" fieldType="physicalValue" fieldName="IS_FILTER" />
			<field name="image_tooltip" fieldType="physicalValue" fieldName="IMAGE_TOOLTIP" />>
			<field name="value" fieldType="physicalValue" fieldName="VALUE" />
			<field name="image_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="IMAGE_URL" fileAssetInternal="IMAGE_ID"/>
			
	</multidata>
	
	<!--category sku 属性分类 -->
	<multidata name="sku_attributes" keyName="CATEGORY_SKU_ATTR_METADATA_ID" tableName="VW_CATEGORY_SKU_ATTR"  filter="CATEGORY_METADATA_ID=(SELECT CATEGORY_METADATA_ID FROM VW_PRODUCT WHERE PRODUCT_METADATA_ID=@product_id AND lang=@lang) AND lang=@lang" >
		<field name="attrname" fieldType="physicalValue" fieldName="CATEGORY_SKU_ATTR_NAME"/>
		
		<!-- category sku 属性分类值 -->
		<multidata name="sku_attributes_values" sqlResource="SELECT
	d.ATTR_VALUE,
	d.IMAGE_ID,
	d.CATEGORY_SKU_ATTR_VALUES_METADATA_ID
FROM
	VW_CATEGORY_SKU_ATTR_VALUES d
WHERE
	d.CATEGORY_SKU_ATTR_METADATA_ID = @@CATEGORY_SKU_ATTR_METADATA_ID
AND d.LANG = @lang" >
			<field name="attr_value" fieldType="physicalValue" fieldName="ATTR_VALUE"/>
			<field name="category_sku_attr_values_metadata_id" fieldType="physicalValue" fieldName="CATEGORY_SKU_ATTR_VALUES_METADATA_ID"/>
			<field name="attr_image_url" fieldType="internalFileAsset" fieldName="IMAGE_ID"/>
		</multidata>
		
	</multidata>
	
	<!-- 产品video -->
	<multidata name="product_video" tableName="VW_PRODUCT_VIDEO" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
			<field name="video_title" fieldType="physicalValue" fieldName="PRODUCT_VIDEO_NAME"/>
			<field name="video_url" fieldType="physicalFileAsset" fileAssetSource="FILE_SOURCE" fileAssetExternal="FILE_URL" fileAssetInternal="FILE_ID"/>
	</multidata>
	<!-- 产品 parts -->
	<multidata name="product_parts" tableName="VW_PRODUCT_PART" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
			<field name="part_name" fieldType="physicalValue" fieldName="PRODUCT_PART_NAME"/>
			<field name="part_url" fieldType="physicalFileAsset" fileAssetSource="IMAGE_SOURCE" fileAssetExternal="IMAGE_URL" fileAssetInternal="IMAGE_ID"/>
	</multidata>
	<!-- 产品 CAD -->
	<multidata name="product_cads" tableName="VW_PRODUCT_CAD" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
			<field name="cad_name" fieldType="physicalValue" fieldName="PRODUCT_CAD_NAME"/>
			<field name="cad_type" fieldType="physicalMasterData" fieldName="CAD_TYPE" masterDataType="TYPE_CAD_TYPE"/>
			<field name="suffix" fieldType="physicalValue" fieldName="SUFFIX"/>
			<field name="cad_url" fieldType="physicalFileAsset" fileAssetSource="FILE_SOURCE" fileAssetExternal="FILE_URL" fileAssetInternal="FILE_ID"/>
	</multidata>
	<!-- 产品pdf -->
	<multidata name="product_pdf" tableName="VW_PRODUCT_PDF" filter="PRODUCT_METADATA_ID=@product_id AND LANG=@lang">
			<field name="pdf_name" fieldType="physicalValue" fieldName="PRODUCT_PDF_NAME"/>
			<field name="pdf_url" fieldType="physicalFileAsset" fileAssetSource="FILE_SOURCE" fileAssetExternal="FILE_URL" fileAssetInternal="FILE_ID"/>
	</multidata>
</page>
